(()=>{var T=Object.defineProperty,q=Object.defineProperties;var _=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable;var k=(c,o,l)=>o in c?T(c,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[o]=l,v=(c,o)=>{for(var l in o||(o={}))I.call(o,l)&&k(c,l,o[l]);if(w)for(var l of w(o))S.call(o,l)&&k(c,l,o[l]);return c},D=(c,o)=>q(c,_(o));var u=(c,o,l)=>new Promise((m,d)=>{var h=t=>{try{s(l.next(t))}catch(i){d(i)}},e=t=>{try{s(l.throw(t))}catch(i){d(i)}},s=t=>t.done?m(t.value):Promise.resolve(t.value).then(h,e);s((l=l.apply(c,o)).next())});(function(){let c=$("body");function o(){if(window.location.host!=="ielts.neea.cn"){alert("\u8BF7\u52FF\u5728\u975Eielts.neea.cn\u6FC0\u6D3B\u672C\u9ED1\u79D1\u6280");return}if(document.location.protocol!=="https:"){alert("\u8BF7\u4F7F\u7528ielts.neea.cn\u7684https\u7248\u672C"),window.location.href="https://ielts.neea.cn/login";return}if(window.__hkj){alert("\u8BF7\u52FF\u91CD\u590D\u52A0\u8F7D\u9ED1\u79D1\u6280");return}window.__hkj=!0;let h=window.location.href.match(/myHome\/(\d+)\//);if(!h||h.length<2||!h[1]){alert("\u83B7\u53D6\u62A5\u540DID\u5931\u8D25\uFF0C\u8BF7\u5148\u767B\u5F55\u96C5\u601D\u8003\u8BD5\u62A5\u540D\u7F51\u7AD9"),window.location.href="https://ielts.neea.cn/login";return}l().then().catch(e=>{console.error(e)})}function l(){return u(this,null,function*(){let d=`
        <div id="__hkj_loading" style="
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        height: 100%;
        width: 100%;
        position: fixed;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        z-index: 1000;
        overflow-x:hidden;
        overflow-y:auto;
        ">
            <h1>Loading...</h1>
        </div>
        `,h=`
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.13/lib/theme-chalk/index.css">
        <style>
            .rainbow {
                font-family: 'Roboto', sans-serif;
                background: linear-gradient(to right, #6666ff, #0099ff, #00ff00, #ff3399, #6666ff);
                -webkit-background-clip: text;
                color: transparent;
                animation: rainbow_animation 6s ease-in-out infinite;
                background-size: 400% 100%;
            }
            @keyframes rainbow_animation {
                0%, 100% {
                    background-position: 0 0;
                }
    
                50% {
                    background-position: 100% 0;
                }
            }
            .el-loading-spinner .circular{
                display: inline;
            }
            
            #__hkj_app_container{
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                height: 100%;
                width: 100%;
                position: fixed;
                background-color: #fff;
                z-index: 1001;
                overflow-x:hidden;
                overflow-y:auto;
            }
            
            #__hkj_app{
                padding: 30px;
            }
        </style>
        `;c.css("overflow-y","hidden"),c.append(d),$("head link").remove(),$("head").append(h);let e=["https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js","https://cdn.jsdelivr.net/npm/element-ui@2.15.13/lib/index.min.js"];for(let s of e)yield new Promise((t,i)=>{let n=document.createElement("script");n.src=s,n.onload=a=>{console.log(s+" loaded!"),t()},n.onerror=a=>{i(a)},document.head.append(n)});m()})}function m(){let d=`
        <div id="__hkj_app_container">
            <div id="__hkj_app">
                <h2 class="rainbow text-5xl mb-1">{{ title }}</h2>
                <p class="mb-1"><a href="https://github.com/mydansun/ielts.cn_hkj" target="_blank">https://github.com/mydansun/ielts.cn_hkj</a></p>
                <hr class="my-2">
                <section class="mb-4" v-if="queryCities.length > 0">
                    <el-button type="warning" @click="resetQuery" v-if="!fetching">\u91CD\u7F6E\u9009\u62E9</el-button>
                    <el-button type="danger" @click="refreshPage" v-if="fetching">\u6B63\u5728\u5237\u65B0\u8003\u4F4D\uFF0C\u70B9\u6B64\u5237\u65B0\u7F51\u9875\u4EE5\u5F3A\u884C\u7EC8\u6B62</el-button>
                </section>
                <section class="mb-4">
                    <div class="mb-3">
                        <p class="mb-1">\u8BF7\u9009\u62E9\u8003\u8BD5\u7C7B\u522B</p>
                        <el-select v-model="selectedProductCode" placeholder="\u8BF7\u9009\u62E9" :disabled="typeCityDisabled" style="width: 200px;">
                            <el-option :key="product.value" :value="product.value" v-for="product in products" :label="product.name"></el-option>
                        </el-select>
                    </div>
                    <template v-if="cites.length > 0 && !typeCityDisabled">
                        <div class="mb-3">
                            <p class="mb-1">\u8BF7\u9009\u62E9\u4E0B\u4E00\u6B65\u67E5\u8BE2\u7684\u8003\u8BD5\u57CE\u5E02\uFF08\u53EF\u591A\u9009\uFF09</p>
                            <el-select v-model="selectedCites" placeholder="\u8BF7\u9009\u62E9" multiple filterable style="width: 400px;">
                                <el-option :key="city.value" :value="city" v-for="city in cites" :label="city.name">
                                </el-option>
                            </el-select>
                        </div>
                        <el-button type="primary" @click="updateCities">
                            \u4E0B\u4E00\u6B65
                        </el-button>
                    </template>
                    <hr class="my-2">
                </section>
                <section class="mb-4" v-if="queryCities.length > 0">
                    <div class="mb-3">
                        <p class="mb-1">\u4E0B\u9762\u662F\u4F60\u9009\u62E9\u7684\u57CE\u5E02</p>
                        <ul class="list-disc list-inside">
                            <li v-for="queryCity in queryCities" :key="queryCity.value">
                                {{ queryCity.name }}
                                <code>{{ queryCity.value }}</code>
                            </li>
                        </ul>
                    </div>
                    <template v-if="!dateDisabled">
                        <div class="mb-3" v-if="availableDates.length > 0">
                            <p class="mb-1">\u6839\u636E\u4F60\u9009\u62E9\u7684\u57CE\u5E02\uFF0C\u53EF\u7528\u7684\u8003\u8BD5\u65E5\u671F\u5982\u4E0B\uFF0C\u8BF7\u9009\u62E9\u8981\u67E5\u8BE2\u65E5\u671F\uFF08\u53EF\u591A\u9009\uFF09</p>
                            <el-select v-model="selectedDates" placeholder="\u8BF7\u9009\u62E9" multiple filterable style="width: 400px;">
                                <el-option :value="availableDate" v-for="availableDate in availableDates" :key="availableDate" :label="availableDate">
                                </el-option>
                            </el-select>
                        </div>
                        <el-button type="primary" @click="updateDates">
                            \u4E0B\u4E00\u6B65
                        </el-button>
                    </template>
                    <hr class="my-2">
                </section>
                <section class="mb-4" v-if="queryDates.length > 0">
                    <div class="mb-3">
                        <p class="mb-1">\u4E0B\u9762\u662F\u4F60\u9009\u62E9\u7684\u65E5\u671F</p>
                        <ul class="list-disc list-inside">
                            <li v-for="queryDate in queryDates" :key="queryDate">
                                {{ queryDate }}
                            </li>
                        </ul>
                    </div>
                    <hr class="my-2">
                    <div class="mb-3">
                        <p class="mb-1">
                            \u4E0B\u9762\u662F\u67E5\u8BE2\u5230\u7684\u53EF\u4EE5\u62A5\u8003\u7684\u8003\u4F4D
                            <span class="rainbow">
                                \uFF08<strong v-if="lastUpdated">\u66F4\u65B0\u4E8E {{ lastUpdated }}</strong> | \u6BCF\u9694 {{ refreshInterval / 1000 }} \u79D2\u81EA\u52A8\u5237\u65B0\u4E2D...\uFF09
                            </span>
                        </p>
                        <el-table :data="tests" border stripe style="width: 100%" row-key="seatId">
                            <el-table-column
                                sortable
                                prop="cityName"
                                label="\u57CE\u5E02">
                            </el-table-column>
                            
                            <el-table-column
                                sortable
                                prop="testDay"
                                label="\u65E5\u671F">
                            </el-table-column>
                            
                            <el-table-column
                                sortable
                                prop="testTime"
                                label="\u65F6\u95F4">
                            </el-table-column>
                            
                            <el-table-column
                                sortable
                                prop="centerName"
                                label="\u8003\u70B9">
                            </el-table-column>
                            
                            <el-table-column
                                sortable
                                prop="levelCode"
                                label="\u8003\u8BD5\u7EA7\u522B">
                            </el-table-column>
                               
                            <el-table-column
                                sortable
                                prop="writtenType"
                                label="\u8003\u8BD5\u7C7B\u578B">
                            </el-table-column>
                            
                            <el-table-column
                                sortable
                                prop="speakType"
                                label="\u53E3\u8BD5\u7C7B\u578B">
                            </el-table-column>
                        </el-table>
                    </div>
                </section>
            </div>
        </div>
        `;c.append(d),new Vue({el:"#__hkj_app",data:function(){return{title:"\u96C5\u601D\u9ED1\u79D1\u6280",selectedProductCode:"",queryProductCode:"",products:[{value:"IELTSPBT",name:"\u666E\u901A\u96C5\u601D \u7EB8\u7B14\u8003\u8BD5"},{value:"IELTSCDI",name:"\u666E\u901A\u96C5\u601D \u673A\u8003"},{value:"IELTSUKVIPBT",name:"\u7B7E\u8BC1\u79FB\u6C11\u96C5\u601D \u7EB8\u7B14\u8003\u8BD5"},{value:"IELTSUKVICDI",name:"\u7B7E\u8BC1\u79FB\u6C11\u96C5\u601D \u673A\u8003"}],cites:[],selectedCites:[],queryCities:[],availableDates:[],selectedDates:[],queryDates:[],tests:[],csrfToken:$("meta[name='_csrf']").attr("content"),sessionHandle:null,refreshHandle:null,loading:null,refreshInterval:30*1e3,lastUpdated:"",foundSeatIds:[],fetching:!1}},computed:{typeCityDisabled(){return this.queryCities.length>0},dateDisabled(){return this.queryDates.length>0}},mounted(){this.sessionHandle=setInterval(()=>{this.refreshToken()},30*1e3)},methods:{initLoading(){this.loading=this.$loading({target:"#__hkj_app"})},closeLoading(){this.loading&&(this.loading.close(),this.loading=null)},resetQuery(){this.initLoading(),this.cleanRefreshHandle(),this.tests=[],this.queryDates=[],this.selectedDates=[],this.availableDates=[],this.queryCities=[],this.selectedCites=[],this.cites=[],this.queryProductCode="",this.selectedProductCode="",this.foundSeatIds=[],this.closeLoading()},refreshPage(){window.location.reload()},cleanRefreshHandle(){this.refreshHandle&&(clearTimeout(this.refreshHandle),this.refreshHandle=null)},sleep(e){return u(this,null,function*(){return new Promise(s=>{setTimeout(()=>{s()},e)})})},refreshToken(){$.ajax({type:"GET",url:"homepage",success:e=>{let t=$(e).find("meta[name='_csrf']").attr("content");t&&t!==this.csrfToken&&(this.csrfToken=t,console.log("csrfToken changed to %s",this.csrfToken))}})},updateCities(){return u(this,null,function*(){this.initLoading(),this.queryProductCode=this.selectedProductCode,this.queryCities.splice(0),this.availableDates.splice(0),this.queryCities=this.selectedCites.slice();let e=[];for(let{name:s,value:t}of this.queryCities){let i=yield new Promise(a=>{$.getJSON("getTestDate",{productCode:this.queryProductCode,cityCode:t},p=>{a(p)})}),n=Object.keys(i);console.log("%s\u6709%d\u4E2A\u53EF\u7528\u65E5\u671F.",s,n.length);for(let a of n)e.includes(a)||e.push(a);yield this.sleep(100)}e.sort(),this.availableDates=e,this.closeLoading()})},updateDates(){return u(this,null,function*(){let e=Notification.permission;e==="default"?yield new Promise(t=>{this.$confirm("\u662F\u5426\u6253\u5F00\u6D4F\u89C8\u5668\u901A\u77E5\uFF0C\u8FD9\u5C06\u5728\u6709\u65B0\u8003\u4F4D\u65F6\u901A\u77E5\u4F60","\u63D0\u793A",{confirmButtonText:"\u6253\u5F00",cancelButtonText:"\u53D6\u6D88",type:"warning"}).then(()=>{Notification.requestPermission().then(i=>{i==="granted"?this.$message.success("\u6D88\u606F\u901A\u77E5\u5DF2\u6253\u5F00\uFF0C\u5C06\u5728\u6709\u8003\u4F4D\u7684\u65F6\u5019\u901A\u77E5\u4F60"):this.$message.error("\u6D88\u606F\u901A\u77E5\u6253\u5F00\u5931\u8D25\uFF0C\u65E0\u6CD5\u901A\u77E5\u65B0\u8003\u4F4D"),t()})}).catch(()=>{t()})}):e==="denied"?this.$message.error("\u6D88\u606F\u901A\u77E5\u6743\u9650\u88AB\u5173\u95ED\uFF0C\u65E0\u6CD5\u901A\u77E5\u65B0\u8003\u4F4D"):e==="granted"&&this.$message.success("\u6D88\u606F\u901A\u77E5\u5DF2\u6253\u5F00\uFF0C\u5C06\u5728\u6709\u8003\u4F4D\u7684\u65F6\u5019\u901A\u77E5\u4F60"),this.initLoading(),this.cleanRefreshHandle(),this.queryDates=this.selectedDates.slice();let s=yield this.fetchSeats();this.foundSeatIds=s.map(t=>t.seatId),console.log("%d\u4E2A\u57CE\u5E02\u603B\u5171\u67E5\u8BE2\u5230%d\u4E2A\u8003\u4F4D",this.queryCities.length,s.length,s),this.tests=s,this.refreshHandle=setTimeout(()=>{this.continuesUpdate()},this.refreshInterval),this.closeLoading()})},continuesUpdate(){return u(this,null,function*(){let e=yield this.fetchSeats(),s=e.map(i=>i.seatId),t=s.filter(i=>!this.foundSeatIds.includes(i));t.length>0&&Notification.permission==="granted"&&new Notification("\u96C5\u601D\u9ED1\u79D1\u6280",{body:"\u4E3A\u4F60\u627E\u5230\u4E86\u65B0\u7684\u8003\u4F4D",icon:"https://ielts.neea.cn/project/ielts/v2/image/newlogo-4.png",tag:t[0],requireInteraction:!0}),this.tests=e,this.foundSeatIds=Array.from(new Set(s.concat(this.foundSeatIds))),console.log("\u5DF2\u66F4\u65B0\uFF0C%d\u4E2A\u57CE\u5E02\u603B\u5171\u67E5\u8BE2\u5230%d\u4E2A\u8003\u4F4D\uFF0C\u65B0\u589E\u8003\u4F4D%d",this.queryCities.length,e.length,t.length),console.log(e),this.refreshHandle&&(this.refreshHandle=setTimeout(()=>{this.continuesUpdate()},this.refreshInterval))})},fetchSeats(){return u(this,null,function*(){this.fetching=!0;let e=[];this.lastUpdated=new Date().toLocaleString();for(let{name:s,value:t}of this.queryCities)for(let i of this.queryDates){let n=new URLSearchParams;n.append("productCode",this.queryProductCode),n.append("queryCity",t),n.append("queryTestDate",i),n.append("queryActionType","Order.QueryOrder"),n.append("neeaAppId","");let a=yield new Promise(f=>{$.ajax({type:"POST",headers:{"X-CSRF-TOKEN":this.csrfToken},dataType:"json",url:"queryTestSeats",data:n.toString(),success:b=>{f(b)}})});!a||!(a!=null&&a.testDay)?console.log("%s\u5728%s\u6CA1\u6709\u8003\u4F4D\u4FE1\u606F",s,i):console.log("%s\u5728%s\u6709\u8003\u4F4D\u4FE1\u606F",s,i,a);let p={cityCode:a.cityCode,cityName:a.cityName,testDay:a.testDay,changeDeadline:a.rescheduleAndCancelDeadline},y=a==null?void 0:a.testSeats,C=0;if(y&&y.length>0)for(let f of y){let b={testTime:f.testTime},g=f==null?void 0:f.testSeat;if(g&&g.length>0)for(let r of g)r.seatStatus===1&&r.optStatus===1&&(C+=1,e.push(D(v(v({},p),b),{seatId:r.seatId,centerCode:r.centerCode,centerName:r.centerName,levelCode:r.levelCode,writtenType:r.writtenType,speakType:r.speakType})))}console.log("%s\u5728%s\u6709%d\u4E2A\u8003\u4F4D",s,i,C),yield this.sleep(100)}return this.fetching=!1,e})}},watch:{selectedProductCode(e,s){e&&(console.log("Change product from %s to %s",s,e),this.initLoading(),this.cites.splice(0),this.selectedCites.splice(0),e&&$.getJSON("getTestCenterProvinceCity",{productCode:e},t=>{let i=[];for(let n of t){let a=n.cities;for(let p of a)i.push({name:n.provinceNameCn+" - "+p.cityNameCn,value:p.cityCode})}console.log("cities updated",i),this.cites=i,this.closeLoading()}))}}})}o()})();})();
